# PPT Coach - Database Specification

## 1. 개요

### 1.1 DBMS
| 환경 | DBMS | 설명 |
|------|------|------|
| 개발/로컬 | SQLite | 단일 파일 DB, 설치 불필요 |
| 운영/확장 | PostgreSQL | 다중 사용자, 고가용성 지원 |

---

## 2. ER 다이어그램

```
┌──────────────┐       ┌──────────────┐       ┌──────────────┐
│   Template   │       │     Step     │       │  Checkpoint  │
├──────────────┤       ├──────────────┤       ├──────────────┤
│ id (PK)      │──────<│ id (PK)      │──────<│ id (PK)      │
│ name         │       │ templateId   │       │ stepId (FK)  │
│ description  │       │ stepIndex    │       │ text         │
│ stepCount    │       │ title        │       │ validationType│
│ estimatedMin │       │ description  │       │ expectedValue│
│ createdAt    │       │ slideIndex   │       │ order        │
└──────────────┘       └──────────────┘       └──────────────┘
                              │
                              │
                       ┌──────────────┐
                       │  Highlight   │
                       ├──────────────┤
                       │ id (PK)      │
                       │ stepId (FK)  │
                       │ target       │
                       │ path         │
                       │ coordinates  │
                       │ tooltip      │
                       │ arrowDirection│
                       └──────────────┘

┌──────────────┐
│   Session    │
├──────────────┤
│ id (PK)      │
│ userId       │
│ templateId   │───────> Template.id
│ currentStep  │
│ completedCPs │
│ createdAt    │
│ lastUpdatedAt│
└──────────────┘
```

---

## 3. 테이블 정의

### 3.1 Template (템플릿)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | VARCHAR(50) | PK | 템플릿 고유 식별자 |
| name | VARCHAR(100) | NOT NULL | 템플릿 이름 |
| description | TEXT | | 템플릿 설명 |
| step_count | INTEGER | NOT NULL | 총 단계 수 |
| estimated_minutes | INTEGER | | 예상 소요 시간(분) |
| created_at | TIMESTAMP | DEFAULT NOW | 생성 일시 |

```sql
CREATE TABLE template (
    id VARCHAR(50) PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    step_count INTEGER NOT NULL,
    estimated_minutes INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 Step (단계)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | VARCHAR(50) | PK | 단계 고유 식별자 |
| template_id | VARCHAR(50) | FK, NOT NULL | 소속 템플릿 |
| step_index | INTEGER | NOT NULL | 단계 순서 (1부터 시작) |
| title | VARCHAR(200) | NOT NULL | 단계 제목 |
| description | TEXT | | 단계 설명 |
| slide_index | INTEGER | NOT NULL | 대상 슬라이드 번호 |

```sql
CREATE TABLE step (
    id VARCHAR(50) PRIMARY KEY,
    template_id VARCHAR(50) NOT NULL,
    step_index INTEGER NOT NULL,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    slide_index INTEGER NOT NULL,
    FOREIGN KEY (template_id) REFERENCES template(id) ON DELETE CASCADE
);

CREATE INDEX idx_step_template ON step(template_id);
CREATE UNIQUE INDEX idx_step_order ON step(template_id, step_index);
```

### 3.3 Checkpoint (체크포인트)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | VARCHAR(50) | PK | 체크포인트 고유 식별자 |
| step_id | VARCHAR(50) | FK, NOT NULL | 소속 단계 |
| text | VARCHAR(500) | NOT NULL | 체크포인트 설명 |
| validation_type | VARCHAR(50) | NOT NULL | 검증 유형 |
| expected_value | JSON | | 기대값 (JSON 형식) |
| order_num | INTEGER | NOT NULL | 표시 순서 |

```sql
CREATE TABLE checkpoint (
    id VARCHAR(50) PRIMARY KEY,
    step_id VARCHAR(50) NOT NULL,
    text VARCHAR(500) NOT NULL,
    validation_type VARCHAR(50) NOT NULL,
    expected_value JSON,
    order_num INTEGER NOT NULL,
    FOREIGN KEY (step_id) REFERENCES step(id) ON DELETE CASCADE
);

CREATE INDEX idx_checkpoint_step ON checkpoint(step_id);
```

### 3.4 Highlight (하이라이트)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | VARCHAR(50) | PK | 하이라이트 고유 식별자 |
| step_id | VARCHAR(50) | FK, NOT NULL | 소속 단계 |
| target | VARCHAR(20) | NOT NULL | 대상 유형 (menu/ribbon/slide/shape) |
| path | VARCHAR(200) | | 메뉴 경로 또는 요소 식별자 |
| coordinates | JSON | | 좌표 정보 {x, y, width, height} |
| tooltip | VARCHAR(200) | | 툴팁 텍스트 |
| arrow_direction | VARCHAR(10) | | 화살표 방향 (top/right/bottom/left) |

```sql
CREATE TABLE highlight (
    id VARCHAR(50) PRIMARY KEY,
    step_id VARCHAR(50) NOT NULL,
    target VARCHAR(20) NOT NULL CHECK (target IN ('menu', 'ribbon', 'slide', 'shape')),
    path VARCHAR(200),
    coordinates JSON,
    tooltip VARCHAR(200),
    arrow_direction VARCHAR(10) CHECK (arrow_direction IN ('top', 'right', 'bottom', 'left')),
    FOREIGN KEY (step_id) REFERENCES step(id) ON DELETE CASCADE
);

CREATE INDEX idx_highlight_step ON highlight(step_id);
```

### 3.5 Session (세션)

| 컬럼 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | VARCHAR(50) | PK | 세션 고유 식별자 |
| user_id | VARCHAR(100) | NOT NULL | 사용자 식별자 |
| template_id | VARCHAR(50) | FK, NOT NULL | 진행 중인 템플릿 |
| current_step | INTEGER | NOT NULL, DEFAULT 1 | 현재 단계 번호 |
| completed_checkpoints | JSON | DEFAULT '[]' | 완료된 체크포인트 ID 배열 |
| created_at | TIMESTAMP | DEFAULT NOW | 세션 시작 일시 |
| last_updated_at | TIMESTAMP | DEFAULT NOW | 마지막 업데이트 일시 |

```sql
CREATE TABLE session (
    id VARCHAR(50) PRIMARY KEY,
    user_id VARCHAR(100) NOT NULL,
    template_id VARCHAR(50) NOT NULL,
    current_step INTEGER NOT NULL DEFAULT 1,
    completed_checkpoints JSON DEFAULT '[]',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (template_id) REFERENCES template(id)
);

CREATE INDEX idx_session_user ON session(user_id);
CREATE INDEX idx_session_updated ON session(last_updated_at);
```

---

## 4. 인덱스 전략

| 테이블 | 인덱스 | 용도 |
|--------|--------|------|
| step | idx_step_template | 템플릿별 단계 조회 |
| step | idx_step_order | 템플릿 내 단계 순서 보장 |
| checkpoint | idx_checkpoint_step | 단계별 체크포인트 조회 |
| highlight | idx_highlight_step | 단계별 하이라이트 조회 |
| session | idx_session_user | 사용자별 세션 조회 |
| session | idx_session_updated | 만료 세션 정리용 |

---

## 5. 데이터 마이그레이션

### 5.1 초기 데이터
템플릿과 단계 데이터는 JSON 시드 파일에서 로드:
```
/seeds
  ├── templates.json
  ├── steps.json
  ├── checkpoints.json
  └── highlights.json
```

### 5.2 마이그레이션 스크립트
```
/migrations
  ├── 001_create_tables.sql
  ├── 002_add_indexes.sql
  └── 003_seed_data.sql
```
