# 쿠폰 할인 시스템 PRD

## 1. 배경 및 목적

**해결하려는 문제**
- 프로모션 기간에 고객 구매 전환율 향상 필요 (목표: 15% 증가)
- 재구매율 증대를 위한 타겟팅 마케팅 도구 필요
- 현재 수동 할인 적용으로 CS 처리 시간 하루 평균 2시간 소요

**비즈니스 임팩트**
- 예상 객단가 20% 증가
- 신규 고객 첫 구매 전환율 30% 개선
- CS 처리 시간 90% 감소 (수동 처리 제거)

---

## 2. 쿠폰 유형별 요구사항

### 2.1 상품 쿠폰 (Product Coupon)

**핵심 시나리오**
- 특정 상품 구매 시 즉시 할인 적용
- 예: "A 브랜드 침대 10만원 할인" 쿠폰

**기능 요구사항**

**할인 적용 방식**
```
- 정률 할인: 10%, 15%, 20% 등
- 정액 할인: 5,000원, 10,000원, 50,000원 등
- 최대 할인 금액 설정 (정률일 때)
  예: "20% 할인 (최대 50,000원)"
```

**적용 대상 상품 정의**
```
1. 단일 상품 지정
   - product_id: 12345
   
2. 다중 상품 지정 (OR 조건)
   - product_ids: [12345, 12346, 12347]
   
3. 카테고리 기반
   - category_id: "침구류"
   - 하위 카테고리 포함 여부 옵션
   
4. 브랜드 기반
   - brand_id: "에이스침대"
   
5. 조합 조건
   - brand_id: "에이스침대" AND category_id: "침대"
```

**제약 조건**
```
- 최소 구매 금액: 설정 가능 (예: 100,000원 이상 구매 시)
- 최소 구매 수량: 설정 가능 (예: 2개 이상 구매 시)
- 상품당 적용 개수 제한: 
  예) 쿠폰 1개당 상품 1개만 할인 또는
      쿠폰 1개로 동일 상품 여러 개 할인 가능
```

**실무 엣지 케이스**
```
1. 옵션 상품 처리
   - 문제: "침대 - 킹사이즈" vs "침대 - 퀸사이즈"가 다른 SKU인 경우
   - 해결: 상품 마스터 ID 기준으로 적용, SKU 상관없이 할인
   
2. 묶음 상품 처리
   - 문제: "침대+매트리스 세트"를 하나의 상품으로 판매하는 경우
   - 해결: 번들 상품 ID를 별도로 쿠폰 대상에 포함할지 설정

3. 할인 전 금액이 최소 구매 금액보다 작아지는 경우
   - 예: 최소 10만원 이상 구매 시 쿠폰 적용인데,
         12만원 상품에 5만원 쿠폰 적용 시 7만원이 됨
   - 해결: 할인 전 금액 기준으로 검증
```

---

### 2.2 장바구니 쿠폰 (Cart Coupon)

**핵심 시나리오**
- 전체 주문 금액 기준 할인 적용
- 예: "5만원 이상 구매 시 5천원 할인" 쿠폰

**기능 요구사항**

**할인 적용 방식**
```
- 정률 할인: 전체 금액의 10%, 15% 등
- 정액 할인: 5,000원, 10,000원 등
- 최대 할인 금액 설정 필수
  이유: 고액 주문 시 할인 금액 폭증 방지
  예: 100만원 주문에 10% 쿠폰 = 10만원 할인
```

**적용 조건**
```
1. 최소 주문 금액
   - 설정값: 50,000원, 100,000원, 200,000원 등
   - 금액 계산 기준: 배송비 제외, 상품 금액 합계 기준

2. 적용 대상 상품 필터링 (선택)
   - 전체 상품 대상 (기본값)
   - 특정 카테고리만 포함
   - 특정 브랜드만 포함
   - 제외 상품 설정 (예: 이미 할인 중인 특가 상품 제외)
```

**할인 금액 분배 로직**
```
문제: 장바구니에 여러 상품이 있을 때, 
      5천원 할인을 각 상품에 어떻게 나눠 적용할까?

중요한 이유:
- 부분 취소/환불 시 할인 금액 정산 필요
- 판매자별 정산 시 할인 부담금 분배 필요

해결 방안:
1. 비례 분배 (권장)
   - 상품 A: 30,000원 (60%)
   - 상품 B: 20,000원 (40%)
   - 5,000원 할인 → A: 3,000원, B: 2,000원

2. 최대 할인 우선
   - 가장 비싼 상품부터 할인 차감

3. 원 단위 절사 처리
   - 분배 시 소수점 발생 → 합계 맞추기 위해 가장 비싼 상품에 나머지 할당
```

**실무 엣지 케이스**
```
1. 배송비 포함 여부
   - 문제: 최소 주문 금액 5만원인데, 상품 48,000원 + 배송비 3,000원 = 51,000원
   - 해결: 배송비 제외한 상품 금액만 계산 (일반적)
   
2. 즉시 할인 상품이 장바구니에 있을 때
   - 문제: 타임세일 20% 할인 상품 포함 시 쿠폰 적용 순서는?
   - 해결: 
     옵션 1) 즉시 할인 후 금액 기준으로 쿠폰 적용
     옵션 2) 쿠폰 적용 제외
     → 비즈니스 정책 결정 필요

3. 여러 판매자 상품이 섞인 경우
   - 문제: 오늘의집처럼 판매자가 여럿인 경우
   - 해결: 
     - 플랫폼 쿠폰: 전체 합산 금액 기준
     - 판매자별 정산 시 할인 부담금 배분 정책 필요
```

---

## 3. 공통 요구사항

### 3.1 쿠폰 발급 및 관리

**쿠폰 생성 정보**
```
- 쿠폰 코드: 
  - 자동 생성 (UUID 기반) 또는 
  - 수동 입력 (프로모션 코드: "WELCOME2024")
  
- 쿠폰 이름: 관리자용 (예: "신규가입 5천원 쿠폰")
- 쿠폰 설명: 고객에게 노출되는 설명
  
- 유효 기간:
  - 시작일시: 2024-01-01 00:00:00
  - 종료일시: 2024-12-31 23:59:59
  - 발급 후 N일: 발급일로부터 30일 등
```

**발급 수량 관리**
```
- 총 발급 가능 수량: 1,000개 (선착순)
- 사용자당 발급 제한: 1인 1개 제한
- 동시 발급 제어 필요
  → Redis distributed lock 활용
  → 재고 차감과 유사한 동시성 이슈
```

**사용 제한**
```
- 사용 횟수: 1회 사용 후 소진 (일반적)
- 재사용 가능 쿠폰: N회 사용 가능 (예: 정기구독 할인)
- 사용자당 사용 제한: 동일 사용자 N회까지 (예: 월 1회)
```

### 3.2 쿠폰 적용 우선순위 및 중복 정책

**중복 적용 시나리오**
```
장바구니 상황:
- 상품 A (50,000원) + 상품 B (30,000원) = 80,000원

보유 쿠폰:
- 상품 A 10% 할인 쿠폰
- 장바구니 5,000원 할인 쿠폰

질문: 둘 다 적용 가능한가? 적용 순서는?
```

**중복 적용 정책 (비즈니스 결정 필요)**
```
옵션 1: 하나만 선택 (일반적)
- 사용자가 직접 선택
- 자동 최대 할인 선택 로직 제공

옵션 2: 순차 적용 (공격적 프로모션)
- 상품 쿠폰 먼저 적용 → 장바구니 쿠폰 적용
- 예시 계산:
  1. 상품 A: 50,000 → 45,000원 (10% 할인)
  2. 총액: 75,000원 (45,000 + 30,000)
  3. 장바구니 쿠폰: 75,000 → 70,000원
  
옵션 3: 카테고리별 제한
- 상품 쿠폰끼리는 중복 불가
- 상품 쿠폰 + 장바구니 쿠폰은 가능
```

**우선순위 설정**
```
1. 자동 적용 우선순위 (사용자가 선택 안 할 때)
   - Priority 1: 정액 할인이 큰 쿠폰
   - Priority 2: 정률 할인이 큰 쿠폰
   - Priority 3: 먼저 만료되는 쿠폰

2. 쿠폰별 우선순위 메타데이터
   - priority: 1 (높음) ~ 10 (낮음)
   - 비즈니스 정책에 따라 수동 설정
```

### 3.3 성능 및 기술 요구사항

**응답 시간 목표**
```
- 쿠폰 적용 가능 여부 검증: 100ms 이내
- 할인 금액 계산: 50ms 이내
- 쿠폰 사용 처리 (결제 시): 200ms 이내

실무 팁: 
- 장바구니 조회 시 쿠폰 적용 미리보기는 캐싱 필수
- 최종 결제 시점에만 실시간 검증
```

**동시성 처리**
```
1. 쿠폰 발급 시
   - 문제: 1,000개 한정 쿠폰, 동시에 2,000명이 요청
   - 해결: Redis INCR + Lua script 활용
   
2. 쿠폰 사용 시
   - 문제: 동일 쿠폰 중복 사용 방지
   - 해결: 
     - DB unique constraint (user_id, coupon_id)
     - Optimistic locking (version 컬럼)
     - 사용 처리는 트랜잭션 내에서

3. 선착순 쿠폰
   - Redis Sorted Set 활용 (timestamp 기준)
   - 비동기 배치로 DB 반영 (eventual consistency)
```

**데이터베이스 설계 고려사항**
```
핵심 테이블:
1. coupon_policy (쿠폰 정책 마스터)
2. coupon_issuance (발급된 쿠폰)
3. coupon_usage (사용 이력)
4. coupon_product_mapping (상품 쿠폰 대상 상품)

인덱스 필수:
- coupon_issuance: (user_id, status, expired_at)
- coupon_usage: (user_id, created_at)
- coupon_usage: (order_id) - 취소 시 조회용

파티셔닝 고려:
- coupon_usage 테이블은 이력성 데이터
- 월별 파티셔닝으로 조회 성능 유지
```

### 3.4 주문 취소 및 환불 처리

**전체 취소 시**
```
- 사용된 쿠폰 복구 (재사용 가능 상태로)
- 쿠폰 사용 이력은 유지 (감사 목적)
- 재발급 시 유효기간 연장 여부 결정 필요
  예: 원래 유효기간이 지났다면? → 비즈니스 정책
```

**부분 취소 시 (상품 쿠폰)**
```
시나리오:
- 상품 A (50,000원) + 상품 B (30,000원)
- 상품 A에 10,000원 쿠폰 적용
- 상품 A만 취소

처리 방법:
1. 쿠폰 복구하고 상품 B에 재적용 가능하게
2. 쿠폰 소진 처리 (취소해도 복구 안 됨)
→ 비즈니스 정책 결정 필요

권장: 케이스별로 CS가 수동 처리할 수 있는 관리자 기능 제공
```

**부분 취소 시 (장바구니 쿠폰)**
```
시나리오:
- 상품 A (60,000원) + 상품 B (40,000원) = 100,000원
- 장바구니 10,000원 할인 쿠폰 적용 (비례 분배: A에 6천원, B에 4천원)
- 상품 A만 취소

환불 금액 계산:
- 상품 A: 60,000 - 6,000 = 54,000원 환불
- 남은 주문: 상품 B (40,000 - 4,000 = 36,000원)

검증 로직:
- 남은 금액(40,000원)이 최소 주문 금액(예: 50,000원) 미달
- 처리 방법:
  1. 쿠폰 효과 전체 취소, 추가 환불 발생
  2. 그대로 유지 (고객 유리하게)
  → 권장: 그대로 유지, CS 비용 절감
```

---

## 4. API 설계 가이드

### 4.1 주요 API 엔드포인트

```
1. 쿠폰 발급
POST /api/v1/coupons/{couponPolicyId}/issue
- 선착순 제어
- 중복 발급 검증
- 응답 시간 목표: 200ms

2. 내 쿠폰 목록 조회
GET /api/v1/users/me/coupons
- 사용 가능 쿠폰만 / 전체
- 상품별 적용 가능 쿠폰 필터링
- 캐싱 적용 (Redis, TTL 5분)

3. 쿠폰 적용 미리보기
POST /api/v1/coupons/preview
Request:
{
  "cartItems": [...],
  "couponIds": [123, 456]
}
Response:
{
  "originalAmount": 100000,
  "discountAmount": 15000,
  "finalAmount": 85000,
  "appliedCoupons": [...]
}

4. 주문 시 쿠폰 사용
POST /api/v1/orders
- 최종 검증 (재고, 가격, 쿠폰 유효성)
- 트랜잭션 처리
- 실패 시 롤백 전략
```

### 4.2 에러 처리

```
명확한 에러 코드와 메시지 제공:

- COUPON_EXPIRED: "쿠폰 유효기간이 만료되었습니다"
- COUPON_SOLDOUT: "선착순 쿠폰이 모두 소진되었습니다"
- MINIMUM_AMOUNT_NOT_MET: "최소 주문 금액 50,000원을 충족하지 않습니다"
- COUPON_ALREADY_USED: "이미 사용된 쿠폰입니다"
- PRODUCT_NOT_APPLICABLE: "해당 상품에는 쿠폰을 적용할 수 없습니다"
- COUPON_CONFLICT: "선택한 쿠폰들은 중복 사용할 수 없습니다"

프론트엔드 UX 개선:
- 적용 불가능한 쿠폰은 회색 처리 + 툴팁으로 이유 설명
- 최대 할인 쿠폰 자동 추천
```

---

## 5. 성공 지표 (KPI)

### 비즈니스 지표
```
- 쿠폰 발급률: 발급된 쿠폰 / 전체 사용자
  목표: 30% (신규 가입 쿠폰 기준)
  
- 쿠폰 사용률: 사용된 쿠폰 / 발급된 쿠폰
  목표: 60% (업계 평균 40~50%)
  
- 쿠폰으로 인한 객단가 증가율
  목표: 20% 증가
  
- 쿠폰 사용 고객의 재구매율
  목표: 일반 고객 대비 1.5배
```

### 기술 지표
```
- API 응답 시간 P95: 200ms 이하
- 쿠폰 발급 처리량: 초당 1,000건
- 동시성 이슈로 인한 오발급: 0건
- 쿠폰 관련 CS 처리 시간: 기존 대비 90% 감소
```

---

## 6. 개발 우선순위 (3주 스프린트 기준)

**Week 1: Core 기능**
- [ ] 쿠폰 정책 CRUD
- [ ] 상품 쿠폰 발급/사용
- [ ] 기본 할인 계산 로직
- [ ] 단위 테스트 (할인 계산 케이스별)

**Week 2: 확장 기능**
- [ ] 장바구니 쿠폰
- [ ] 중복 적용 정책 구현
- [ ] 동시성 제어 (Redis lock)
- [ ] 성능 테스트 (nGrinder, 1000 TPS)

**Week 3: 운영 기능**
- [ ] 취소/환불 처리
- [ ] 관리자 대시보드
- [ ] 모니터링 (DataDog 알람 설정)
- [ ] 부하 테스트 및 튜닝

---

## 7. 기술 스택 제안

```
- Spring Boot 3.x + Kotlin
- Spring Data JPA (복잡한 쿼리는 QueryDSL)
- Redis (캐싱, 분산 락, 선착순 처리)
- MySQL 8.0 (파티셀닝, 인덱스 최적화)
- Kafka (쿠폰 사용 이벤트 발행 → 정산 시스템 연동)
- DataDog (APM, 쿠폰 사용률 대시보드)
```

**아키텍처 제안**
```
MSA 환경이라면:
- Coupon Service (쿠폰 정책, 발급, 사용)
- Order Service (주문 생성, 쿠폰 적용)
- Payment Service (결제 처리)
- Settlement Service (정산 처리)

Kafka Event:
- CouponIssuedEvent
- CouponUsedEvent
- OrderCancelledEvent → Coupon Service가 구독하여 복구 처리
```

---

## 실무 체크리스트

개발 시작 전 반드시 결정해야 할 사항:

- [ ] 쿠폰 중복 사용 정책 (하나만 vs 순차 적용)
- [ ] 부분 취소 시 쿠폰 복구 정책
- [ ] 즉시 할인 상품과 쿠폰의 관계
- [ ] 최소 주문 금액 계산 기준 (배송비 포함 여부)
- [ ] 판매자별 할인 부담금 정산 방식 (플랫폼 vs 판매자)
- [ ] 선착순 쿠폰 동시성 처리 방식
- [ ] 쿠폰 유효기간 만료 시 알림 발송 여부

이 항목들은 나중에 변경하면 리팩토링 비용이 크니까 먼저 정리하고 시작하세요!

---

실무에서 가장 까다로운 부분은 **"부분 취소 시 할인 금액 분배 로직"**이에요. 정산 시스템과 연동되면 한 번 잘못 계산하면 회계 전체가 꼬이거든요.

혹시 특정 부분 더 자세히 설계하고 싶은 게 있으면 말씀해주세요. 예를 들어 동시성 제어 로직을 코드 레벨로 보여드리거나, DB 스키마 설계를 구체적으로 잡아드릴 수 있어요!