# PPT Coach - Backend Unit Test 명세

## 1. 소개 및 범위

### 1.1 단위 테스트 정의
단위 테스트는 **하나의 기능 단위를 독립적으로 검증**하는 테스트입니다. 외부 의존성은 모킹(mocking)하여 순수한 로직만을 테스트합니다.

### 1.2 테스트 범위

#### ✅ 단위 테스트 대상
- 단일 함수 (유틸리티 함수, 헬퍼 함수)
- 단일 API 엔드포인트 (라우트 핸들러)
- 단일 비즈니스 로직 메서드 (서비스 레이어)
- 단일 데이터 접근 메서드 (Repository)

#### ❌ 단위 테스트 아님 (통합 테스트 영역)
- 데이터베이스 통합 테스트
- 외부 API 호출 테스트
- 다중 컴포넌트 워크플로우 테스트
- E2E (End-to-End) 테스트

### 1.3 기술 스택
| 구분 | 기술 | 버전 |
|------|------|------|
| Runtime | Node.js | 20 LTS |
| Framework | Express / Fastify | - |
| Database | SQLite (로컬) / PostgreSQL (운영) | - |
| Test Framework | Vitest (권장) | ^1.2.0 |
| API Testing | Supertest | ^6.3.4 |
| In-Memory DB | better-sqlite3 | ^9.3.0 |

---

## 2. 테스트 프레임워크 설정

### 2.1 의존성 패키지

```json
{
  "devDependencies": {
    "vitest": "^1.2.0",
    "@vitest/ui": "^1.2.0",
    "@vitest/coverage-v8": "^1.2.0",
    "supertest": "^6.3.4",
    "better-sqlite3": "^9.3.0",
    "@faker-js/faker": "^8.4.0"
  },
  "scripts": {
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:coverage": "vitest --coverage",
    "test:ui": "vitest --ui"
  }
}
```

### 2.2 Vitest 설정

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'node',
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'tests/',
        '**/*.config.ts',
        '**/fixtures/**'
      ],
      lines: 90,
      functions: 90,
      branches: 85,
      statements: 90
    },
    setupFiles: ['./tests/setup.ts']
  }
});
```

### 2.3 테스트 디렉토리 구조

```
backend/
├── src/
│   ├── routes/              # API 라우트
│   │   ├── templates.ts
│   │   ├── sessions.ts
│   │   └── validation-rules.ts
│   ├── services/            # 비즈니스 로직
│   │   ├── SessionService.ts
│   │   └── TemplateService.ts
│   ├── repositories/        # 데이터 접근 계층
│   │   ├── SessionRepository.ts
│   │   └── TemplateRepository.ts
│   └── utils/               # 유틸리티 함수
│       └── progress.ts
└── tests/
    ├── setup.ts             # 테스트 전역 설정
    ├── unit/                # 단위 테스트
    │   ├── routes/
    │   │   ├── templates.test.ts
    │   │   ├── sessions.test.ts
    │   │   └── validation-rules.test.ts
    │   ├── services/
    │   │   ├── SessionService.test.ts
    │   │   └── TemplateService.test.ts
    │   ├── repositories/
    │   │   ├── SessionRepository.test.ts
    │   │   └── TemplateRepository.test.ts
    │   └── utils/
    │       └── progress.test.ts
    ├── fixtures/            # 테스트 데이터
    │   ├── templates.json
    │   ├── sessions.json
    │   └── validation-rules.json
    └── factories/           # 테스트 데이터 팩토리
        ├── TemplateFactory.ts
        ├── SessionFactory.ts
        └── index.ts
```

---

## 3. 데이터베이스 테스트 전략 (Mock + In-memory 혼합)

### 3.1 전략 개요

효율적인 단위 테스트를 위해 **계층별로 다른 전략**을 적용합니다:
- **서비스/라우트 레이어**: Mock 사용
- **Repository 레이어**: In-memory SQLite 사용

### 3.2 Mock을 사용하는 경우

#### 라우트 핸들러 테스트
```typescript
// tests/unit/routes/sessions.test.ts
import { describe, it, expect, vi } from 'vitest';
import request from 'supertest';
import { app } from '../../../src/app';
import * as SessionService from '../../../src/services/SessionService';

describe('POST /api/sessions', () => {
  it('should_createSession_when_validData', async () => {
    // Arrange - 서비스 레이어를 Mock
    const mockCreateSession = vi.spyOn(SessionService, 'createSession')
      .mockResolvedValue({
        sessionId: 'sess-123',
        templateId: 'result-report',
        currentStep: 1,
        createdAt: new Date()
      });

    // Act
    const response = await request(app)
      .post('/api/sessions')
      .send({ templateId: 'result-report', userId: 'user-123' });

    // Assert
    expect(response.status).toBe(201);
    expect(response.body.sessionId).toBe('sess-123');
    expect(mockCreateSession).toHaveBeenCalledWith({
      templateId: 'result-report',
      userId: 'user-123'
    });
  });
});
```

#### 서비스 레이어 테스트
```typescript
// tests/unit/services/SessionService.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { SessionService } from '../../../src/services/SessionService';

describe('SessionService', () => {
  let service: SessionService;
  let mockRepository: any;

  beforeEach(() => {
    // Repository를 Mock
    mockRepository = {
      findById: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn()
    };
    service = new SessionService(mockRepository);
  });

  it('should_calculateProgress_when_called', () => {
    // Arrange
    const completed = ['cp-101', 'cp-102'];
    const total = ['cp-101', 'cp-102', 'cp-201', 'cp-202'];

    // Act
    const progress = service.calculateProgress(completed, total);

    // Assert
    expect(progress).toBe(0.5);
  });
});
```

### 3.3 In-Memory DB를 사용하는 경우

#### Repository 테스트
```typescript
// tests/unit/repositories/SessionRepository.test.ts
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import Database from 'better-sqlite3';
import { SessionRepository } from '../../../src/repositories/SessionRepository';
import { runMigrations } from '../../../src/db/migrations';

describe('SessionRepository', () => {
  let db: Database.Database;
  let repository: SessionRepository;

  beforeEach(() => {
    // In-memory SQLite 데이터베이스 생성
    db = new Database(':memory:');
    runMigrations(db);
    repository = new SessionRepository(db);
  });

  afterEach(() => {
    db.close();
  });

  it('should_createSession_when_validData', () => {
    // Arrange
    const sessionData = {
      id: 'sess-123',
      userId: 'user-123',
      templateId: 'result-report',
      currentStep: 1,
      completedCheckpoints: []
    };

    // Act
    const session = repository.create(sessionData);

    // Assert
    expect(session.id).toBe('sess-123');
    expect(session.userId).toBe('user-123');

    // 실제 DB에서 조회하여 검증
    const found = repository.findById('sess-123');
    expect(found).toBeDefined();
    expect(found.userId).toBe('user-123');
  });
});
```

---

## 4. 테스트 카테고리 및 상세 예제

### 4.1 API 엔드포인트 테스트

모든 API 엔드포인트를 Supertest를 사용하여 테스트합니다.

#### GET /api/templates

```typescript
// tests/unit/routes/templates.test.ts
import { describe, it, expect, vi } from 'vitest';
import request from 'supertest';
import { app } from '../../../src/app';
import * as TemplateService from '../../../src/services/TemplateService';

describe('GET /api/templates', () => {
  it('should_returnTemplateList_when_called', async () => {
    // Arrange
    vi.spyOn(TemplateService, 'getAllTemplates').mockResolvedValue([
      {
        id: 'result-report',
        name: '결과완료보고서',
        description: '프로젝트 결과를 보고하는 문서 템플릿',
        stepCount: 8,
        estimatedMinutes: 30
      }
    ]);

    // Act
    const response = await request(app).get('/api/templates');

    // Assert
    expect(response.status).toBe(200);
    expect(response.body.templates).toHaveLength(1);
    expect(response.body.templates[0].id).toBe('result-report');
  });

  it('should_returnEmptyArray_when_noTemplates', async () => {
    // Arrange
    vi.spyOn(TemplateService, 'getAllTemplates').mockResolvedValue([]);

    // Act
    const response = await request(app).get('/api/templates');

    // Assert
    expect(response.status).toBe(200);
    expect(response.body.templates).toEqual([]);
  });
});
```

#### GET /api/templates/:id

```typescript
describe('GET /api/templates/:id', () => {
  it('should_returnTemplateDetail_when_validId', async () => {
    // Arrange
    const mockTemplate = {
      id: 'result-report',
      name: '결과완료보고서',
      steps: [
        {
          stepId: 1,
          title: '슬라이드 크기 설정',
          checkpoints: [{ id: 'cp-101', text: '슬라이드 크기 16:9' }]
        }
      ]
    };
    vi.spyOn(TemplateService, 'getTemplateById').mockResolvedValue(mockTemplate);

    // Act
    const response = await request(app).get('/api/templates/result-report');

    // Assert
    expect(response.status).toBe(200);
    expect(response.body.id).toBe('result-report');
    expect(response.body.steps).toHaveLength(1);
  });

  it('should_return404_when_templateNotFound', async () => {
    // Arrange
    vi.spyOn(TemplateService, 'getTemplateById').mockResolvedValue(null);

    // Act
    const response = await request(app).get('/api/templates/invalid-id');

    // Assert
    expect(response.status).toBe(404);
    expect(response.body.error).toBe('ERR_TEMPLATE_NOT_FOUND');
  });
});
```

#### POST /api/sessions

```typescript
describe('POST /api/sessions', () => {
  it('should_createSession_when_validData', async () => {
    // Arrange
    const mockSession = {
      sessionId: 'sess-123',
      templateId: 'result-report',
      currentStep: 1,
      createdAt: new Date()
    };
    vi.spyOn(SessionService, 'createSession').mockResolvedValue(mockSession);

    // Act
    const response = await request(app)
      .post('/api/sessions')
      .send({ templateId: 'result-report', userId: 'user-123' });

    // Assert
    expect(response.status).toBe(201);
    expect(response.body.sessionId).toBe('sess-123');
    expect(response.body.templateId).toBe('result-report');
  });

  it('should_return400_when_invalidTemplateId', async () => {
    // Act
    const response = await request(app)
      .post('/api/sessions')
      .send({ templateId: '', userId: 'user-123' });

    // Assert
    expect(response.status).toBe(400);
    expect(response.body.error).toBeDefined();
  });
});
```

#### PATCH /api/sessions/:sessionId

```typescript
describe('PATCH /api/sessions/:sessionId', () => {
  it('should_updateSession_when_validData', async () => {
    // Arrange
    const mockUpdated = {
      sessionId: 'sess-123',
      currentStep: 3,
      completedCheckpoints: ['cp-101', 'cp-102', 'cp-201'],
      lastUpdatedAt: new Date()
    };
    vi.spyOn(SessionService, 'updateSession').mockResolvedValue(mockUpdated);

    // Act
    const response = await request(app)
      .patch('/api/sessions/sess-123')
      .send({ currentStep: 3, completedCheckpoints: ['cp-201'] });

    // Assert
    expect(response.status).toBe(200);
    expect(response.body.currentStep).toBe(3);
    expect(response.body.completedCheckpoints).toHaveLength(3);
  });

  it('should_return400_when_invalidStepNumber', async () => {
    // Act
    const response = await request(app)
      .patch('/api/sessions/sess-123')
      .send({ currentStep: 0 });

    // Assert
    expect(response.status).toBe(400);
    expect(response.body.error).toBe('ERR_INVALID_STEP');
  });
});
```

### 4.2 비즈니스 로직 테스트

#### 진행률 계산

```typescript
// tests/unit/utils/progress.test.ts
import { describe, it, expect } from 'vitest';
import { calculateProgress } from '../../../src/utils/progress';

describe('calculateProgress', () => {
  it('should_returnCorrectPercentage_when_partiallyCompleted', () => {
    // Arrange
    const completed = ['cp-101', 'cp-102'];
    const total = ['cp-101', 'cp-102', 'cp-201', 'cp-202'];

    // Act
    const progress = calculateProgress(completed, total);

    // Assert
    expect(progress).toBe(0.5);
  });

  it('should_return0_when_noneCompleted', () => {
    // Arrange
    const completed: string[] = [];
    const total = ['cp-101', 'cp-102'];

    // Act
    const progress = calculateProgress(completed, total);

    // Assert
    expect(progress).toBe(0);
  });

  it('should_return1_when_allCompleted', () => {
    // Arrange
    const completed = ['cp-101', 'cp-102'];
    const total = ['cp-101', 'cp-102'];

    // Act
    const progress = calculateProgress(completed, total);

    // Assert
    expect(progress).toBe(1);
  });

  it('should_return0_when_totalIsEmpty', () => {
    // Arrange
    const completed: string[] = [];
    const total: string[] = [];

    // Act
    const progress = calculateProgress(completed, total);

    // Assert
    expect(progress).toBe(0);
  });

  it('should_return0_when_invalidInput', () => {
    // Act & Assert
    expect(calculateProgress(null as any, [])).toBe(0);
    expect(calculateProgress([], null as any)).toBe(0);
    expect(calculateProgress(null as any, null as any)).toBe(0);
  });
});
```

#### 세션 복구 로직

```typescript
// tests/unit/services/SessionService.test.ts
describe('SessionService.isSessionRecoverable', () => {
  it('should_returnTrue_when_sessionWithin24Hours', () => {
    // Arrange
    const now = new Date();
    const twelveHoursAgo = new Date(now.getTime() - 12 * 60 * 60 * 1000);
    const session = { lastUpdatedAt: twelveHoursAgo };

    // Act
    const result = service.isSessionRecoverable(session);

    // Assert
    expect(result).toBe(true);
  });

  it('should_returnFalse_when_sessionOlderThan24Hours', () => {
    // Arrange
    const now = new Date();
    const twoDaysAgo = new Date(now.getTime() - 48 * 60 * 60 * 1000);
    const session = { lastUpdatedAt: twoDaysAgo };

    // Act
    const result = service.isSessionRecoverable(session);

    // Assert
    expect(result).toBe(false);
  });

  it('should_returnTrue_when_exactlyAt24HourBoundary', () => {
    // Arrange
    const now = new Date();
    const exactly24HoursAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    const session = { lastUpdatedAt: exactly24HoursAgo };

    // Act
    const result = service.isSessionRecoverable(session);

    // Assert
    expect(result).toBe(true);
  });
});
```

### 4.3 데이터 접근 계층 테스트

#### SessionRepository CRUD 테스트

```typescript
// tests/unit/repositories/SessionRepository.test.ts
describe('SessionRepository', () => {
  describe('create', () => {
    it('should_insertSession_when_validData', () => {
      // Arrange
      const sessionData = {
        id: 'sess-123',
        userId: 'user-123',
        templateId: 'result-report',
        currentStep: 1,
        completedCheckpoints: []
      };

      // Act
      const session = repository.create(sessionData);

      // Assert
      expect(session.id).toBe('sess-123');
      const found = repository.findById('sess-123');
      expect(found).toBeDefined();
    });
  });

  describe('findByUserId', () => {
    it('should_returnUserSessions_when_userHasSessions', () => {
      // Arrange
      repository.create({ id: 'sess-1', userId: 'user-123', templateId: 'tmpl-1' });
      repository.create({ id: 'sess-2', userId: 'user-123', templateId: 'tmpl-2' });
      repository.create({ id: 'sess-3', userId: 'user-456', templateId: 'tmpl-1' });

      // Act
      const sessions = repository.findByUserId('user-123');

      // Assert
      expect(sessions).toHaveLength(2);
      expect(sessions.every(s => s.userId === 'user-123')).toBe(true);
    });

    it('should_returnEmptyArray_when_userHasNoSessions', () => {
      // Act
      const sessions = repository.findByUserId('nonexistent-user');

      // Assert
      expect(sessions).toEqual([]);
    });
  });

  describe('update', () => {
    it('should_updateSession_when_validData', () => {
      // Arrange
      repository.create({ id: 'sess-123', userId: 'user-123', currentStep: 1 });

      // Act
      repository.update('sess-123', {
        currentStep: 3,
        completedCheckpoints: ['cp-101', 'cp-102']
      });

      // Assert
      const updated = repository.findById('sess-123');
      expect(updated.currentStep).toBe(3);
      expect(updated.completedCheckpoints).toHaveLength(2);
    });
  });

  describe('delete', () => {
    it('should_removeSession_when_validId', () => {
      // Arrange
      repository.create({ id: 'sess-123', userId: 'user-123' });

      // Act
      repository.delete('sess-123');

      // Assert
      const found = repository.findById('sess-123');
      expect(found).toBeNull();
    });
  });
});
```

### 4.4 에러 핸들링 테스트

```typescript
// tests/unit/routes/sessions.test.ts
describe('Error Handling', () => {
  it('should_returnERR_SESSION_NOT_FOUND_when_sessionDoesNotExist', async () => {
    // Arrange
    vi.spyOn(SessionService, 'getSession').mockResolvedValue(null);

    // Act
    const response = await request(app).get('/api/sessions/nonexistent');

    // Assert
    expect(response.status).toBe(404);
    expect(response.body.error).toBe('ERR_SESSION_NOT_FOUND');
  });

  it('should_returnERR_SESSION_EXPIRED_when_sessionTooOld', async () => {
    // Arrange
    vi.spyOn(SessionService, 'getSession').mockRejectedValue(
      new Error('ERR_SESSION_EXPIRED')
    );

    // Act
    const response = await request(app).get('/api/sessions/expired-session');

    // Assert
    expect(response.status).toBe(410);
    expect(response.body.error).toBe('ERR_SESSION_EXPIRED');
  });

  it('should_returnERR_INVALID_STEP_when_stepOutOfRange', async () => {
    // Act
    const response = await request(app)
      .patch('/api/sessions/sess-123')
      .send({ currentStep: 999 });

    // Assert
    expect(response.status).toBe(400);
    expect(response.body.error).toBe('ERR_INVALID_STEP');
  });
});
```

---

## 5. 테스트 데이터 팩토리

### 5.1 TemplateFactory

```typescript
// tests/factories/TemplateFactory.ts
import { faker } from '@faker-js/faker';

export class TemplateFactory {
  static create(overrides: Partial<Template> = {}): Template {
    return {
      id: faker.string.uuid(),
      name: faker.lorem.words(3),
      description: faker.lorem.sentence(),
      stepCount: 8,
      estimatedMinutes: 30,
      createdAt: new Date(),
      ...overrides
    };
  }

  static createResultReportTemplate(): Template {
    return this.create({
      id: 'result-report',
      name: '결과완료보고서',
      description: '프로젝트 결과를 보고하는 문서 템플릿',
      stepCount: 8,
      estimatedMinutes: 30
    });
  }

  static createProposalTemplate(): Template {
    return this.create({
      id: 'proposal',
      name: '제안서',
      description: '제안서 작성 템플릿',
      stepCount: 6,
      estimatedMinutes: 25
    });
  }

  static createBatch(count: number): Template[] {
    return Array.from({ length: count }, () => this.create());
  }
}
```

### 5.2 SessionFactory

```typescript
// tests/factories/SessionFactory.ts
import { faker } from '@faker-js/faker';

export class SessionFactory {
  static create(overrides: Partial<Session> = {}): Session {
    return {
      id: faker.string.uuid(),
      userId: faker.string.uuid(),
      templateId: 'result-report',
      currentStep: 1,
      completedCheckpoints: [],
      createdAt: new Date(),
      lastUpdatedAt: new Date(),
      ...overrides
    };
  }

  static createInProgress(currentStep = 3): Session {
    const checkpoints = this.generateCheckpoints(currentStep - 1);
    return this.create({
      currentStep,
      completedCheckpoints: checkpoints,
      lastUpdatedAt: new Date()
    });
  }

  static createCompleted(): Session {
    return this.create({
      currentStep: 8,
      completedCheckpoints: this.generateCheckpoints(8),
      lastUpdatedAt: new Date()
    });
  }

  static createExpired(): Session {
    const twoDaysAgo = new Date();
    twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
    return this.create({
      lastUpdatedAt: twoDaysAgo
    });
  }

  static createRecent(): Session {
    const oneHourAgo = new Date();
    oneHourAgo.setHours(oneHourAgo.getHours() - 1);
    return this.create({
      lastUpdatedAt: oneHourAgo
    });
  }

  private static generateCheckpoints(count: number): string[] {
    return Array.from({ length: count }, (_, i) => `cp-${i + 1}01`);
  }
}
```

### 5.3 StepFactory & CheckpointFactory

```typescript
// tests/factories/StepFactory.ts
export class StepFactory {
  static create(overrides: Partial<Step> = {}): Step {
    return {
      id: faker.string.uuid(),
      templateId: 'result-report',
      stepIndex: 1,
      title: faker.lorem.words(4),
      description: faker.lorem.sentence(),
      slideIndex: 0,
      ...overrides
    };
  }
}

export class CheckpointFactory {
  static create(overrides: Partial<Checkpoint> = {}): Checkpoint {
    return {
      id: faker.string.uuid(),
      stepId: faker.string.uuid(),
      text: faker.lorem.sentence(),
      validationType: 'slide-size',
      expectedValue: { value: '16:9' },
      orderNum: 1,
      ...overrides
    };
  }
}
```

### 5.4 사용 예시

```typescript
// tests/unit/services/SessionService.test.ts
import { SessionFactory } from '../../factories/SessionFactory';

describe('SessionService', () => {
  it('should_processSession_when_inProgress', () => {
    // Arrange - 팩토리 사용
    const session = SessionFactory.createInProgress(3);

    // Act
    const result = service.processSession(session);

    // Assert
    expect(result.currentStep).toBe(3);
    expect(result.completedCheckpoints).toHaveLength(2);
  });

  it('should_detectExpiredSession_when_tooOld', () => {
    // Arrange
    const expiredSession = SessionFactory.createExpired();

    // Act
    const isRecoverable = service.isSessionRecoverable(expiredSession);

    // Assert
    expect(isRecoverable).toBe(false);
  });
});
```

---

## 6. TDD 워크플로우 및 실전 예제

### 6.1 Red-Green-Refactor 사이클

TDD는 다음 3단계를 반복합니다:

1. **Red (빨강)**: 실패하는 테스트를 먼저 작성
2. **Green (초록)**: 테스트를 통과하는 최소한의 코드 작성
3. **Refactor (리팩토링)**: 테스트를 통과한 상태에서 코드 개선

### 6.2 완전한 TDD 예제: 세션 진행률 계산

#### 단계 1 - Red (실패하는 테스트 작성)

```typescript
// tests/unit/utils/progress.test.ts
import { describe, it, expect } from 'vitest';
import { calculateProgress } from '../../../src/utils/progress';

describe('calculateProgress', () => {
  it('should_returnHalf_when_halfCompleted', () => {
    // Arrange
    const completed = ['cp-101', 'cp-102'];
    const total = ['cp-101', 'cp-102', 'cp-201', 'cp-202'];

    // Act
    const progress = calculateProgress(completed, total);

    // Assert
    expect(progress).toBe(0.5);
  });
});
```

**실행 결과:**
```
❌ FAIL  tests/unit/utils/progress.test.ts
  calculateProgress
    ✗ should_returnHalf_when_halfCompleted
      TypeError: calculateProgress is not a function
```

#### 단계 2 - Green (최소 구현)

```typescript
// src/utils/progress.ts
export function calculateProgress(completed: string[], total: string[]): number {
  return completed.length / total.length;
}
```

**실행 결과:**
```
✅ PASS  tests/unit/utils/progress.test.ts
  calculateProgress
    ✓ should_returnHalf_when_halfCompleted (2ms)
```

#### 단계 3 - 엣지 케이스 추가 (다시 Red)

```typescript
describe('calculateProgress', () => {
  it('should_returnHalf_when_halfCompleted', () => {
    const progress = calculateProgress(['cp-101', 'cp-102'], ['cp-101', 'cp-102', 'cp-201', 'cp-202']);
    expect(progress).toBe(0.5);
  });

  it('should_return0_when_noneCompleted', () => {
    const progress = calculateProgress([], ['cp-101', 'cp-102']);
    expect(progress).toBe(0);
  });

  it('should_return1_when_allCompleted', () => {
    const progress = calculateProgress(['cp-101'], ['cp-101']);
    expect(progress).toBe(1);
  });

  it('should_return0_when_emptyTotal', () => {
    const progress = calculateProgress([], []);
    expect(progress).toBe(0); // ❌ 실패 - NaN 반환
  });
});
```

#### 단계 4 - 엣지 케이스 수정 (Green)

```typescript
// src/utils/progress.ts
export function calculateProgress(completed: string[], total: string[]): number {
  if (total.length === 0) return 0;
  return completed.length / total.length;
}
```

**실행 결과:**
```
✅ PASS  tests/unit/utils/progress.test.ts (4 tests)
```

#### 단계 5 - 추가 검증 및 Refactor

```typescript
describe('calculateProgress', () => {
  // ... 기존 테스트들

  it('should_return0_when_invalidInput', () => {
    expect(calculateProgress(null as any, [])).toBe(0);
    expect(calculateProgress([], null as any)).toBe(0);
  });
});
```

```typescript
// src/utils/progress.ts (최종 버전)
export function calculateProgress(completed: string[], total: string[]): number {
  // 입력 검증
  if (!Array.isArray(completed) || !Array.isArray(total)) {
    return 0;
  }

  // 빈 배열 처리
  if (total.length === 0) {
    return 0;
  }

  // 진행률 계산 (최대 100%로 제한)
  const progress = completed.length / total.length;
  return Math.min(progress, 1);
}
```

**최종 결과:**
```
✅ PASS  tests/unit/utils/progress.test.ts (6 tests) 4ms
  calculateProgress
    ✓ should_returnHalf_when_halfCompleted
    ✓ should_return0_when_noneCompleted
    ✓ should_return1_when_allCompleted
    ✓ should_return0_when_emptyTotal
    ✓ should_return0_when_invalidInput
```

### 6.3 TDD 모범 사례

1. **테스트를 먼저 작성** - 구현 전에 테스트 작성
2. **작은 단위로** - 한 번에 하나의 기능만 테스트
3. **빠른 피드백** - 테스트 실행 시간은 밀리초 단위
4. **명확한 이름** - 테스트 이름이 의도를 설명
5. **독립성** - 테스트는 서로 영향을 주지 않음
6. **리팩토링은 Green 상태에서만** - 테스트 통과 후 개선

---

## 7. 완전한 예제: SessionService 테스트 스위트

```typescript
// tests/unit/services/SessionService.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { SessionService } from '../../../src/services/SessionService';
import { SessionFactory } from '../../factories/SessionFactory';
import { TemplateFactory } from '../../factories/TemplateFactory';

describe('SessionService', () => {
  let service: SessionService;
  let mockSessionRepo: any;
  let mockTemplateRepo: any;

  beforeEach(() => {
    mockSessionRepo = {
      findById: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn(),
      findByUserId: vi.fn()
    };

    mockTemplateRepo = {
      findById: vi.fn()
    };

    service = new SessionService(mockSessionRepo, mockTemplateRepo);
  });

  describe('createSession', () => {
    it('should_createSession_when_validTemplate', async () => {
      // Arrange
      const template = TemplateFactory.createResultReportTemplate();
      mockTemplateRepo.findById.mockResolvedValue(template);
      mockSessionRepo.create.mockResolvedValue({
        id: 'sess-123',
        userId: 'user-123',
        templateId: 'result-report',
        currentStep: 1
      });

      // Act
      const session = await service.createSession({
        userId: 'user-123',
        templateId: 'result-report'
      });

      // Assert
      expect(session.id).toBe('sess-123');
      expect(session.currentStep).toBe(1);
      expect(mockTemplateRepo.findById).toHaveBeenCalledWith('result-report');
      expect(mockSessionRepo.create).toHaveBeenCalled();
    });

    it('should_throwError_when_templateNotFound', async () => {
      // Arrange
      mockTemplateRepo.findById.mockResolvedValue(null);

      // Act & Assert
      await expect(
        service.createSession({ userId: 'user-123', templateId: 'invalid' })
      ).rejects.toThrow('ERR_TEMPLATE_NOT_FOUND');
    });
  });

  describe('updateSession', () => {
    it('should_updateProgress_when_validData', async () => {
      // Arrange
      const existingSession = SessionFactory.createInProgress(2);
      mockSessionRepo.findById.mockResolvedValue(existingSession);
      mockSessionRepo.update.mockResolvedValue({
        ...existingSession,
        currentStep: 3,
        completedCheckpoints: [...existingSession.completedCheckpoints, 'cp-201']
      });

      // Act
      const updated = await service.updateSession('sess-123', {
        currentStep: 3,
        newCheckpoint: 'cp-201'
      });

      // Assert
      expect(updated.currentStep).toBe(3);
      expect(updated.completedCheckpoints).toContain('cp-201');
      expect(mockSessionRepo.update).toHaveBeenCalledWith('sess-123', expect.any(Object));
    });

    it('should_throwError_when_sessionNotFound', async () => {
      // Arrange
      mockSessionRepo.findById.mockResolvedValue(null);

      // Act & Assert
      await expect(
        service.updateSession('invalid', { currentStep: 2 })
      ).rejects.toThrow('ERR_SESSION_NOT_FOUND');
    });
  });

  describe('calculateProgress', () => {
    it('should_returnCorrectProgress_when_called', () => {
      // Arrange
      const completed = ['cp-101', 'cp-102', 'cp-201'];
      const total = ['cp-101', 'cp-102', 'cp-201', 'cp-202', 'cp-301'];

      // Act
      const progress = service.calculateProgress(completed, total);

      // Assert
      expect(progress).toBe(0.6);
    });
  });

  describe('isSessionRecoverable', () => {
    it('should_returnTrue_when_recentSession', () => {
      // Arrange
      const recentSession = SessionFactory.createRecent();

      // Act
      const result = service.isSessionRecoverable(recentSession);

      // Assert
      expect(result).toBe(true);
    });

    it('should_returnFalse_when_expiredSession', () => {
      // Arrange
      const expiredSession = SessionFactory.createExpired();

      // Act
      const result = service.isSessionRecoverable(expiredSession);

      // Assert
      expect(result).toBe(false);
    });
  });

  describe('deleteSession', () => {
    it('should_deleteSession_when_validId', async () => {
      // Arrange
      const session = SessionFactory.create({ id: 'sess-123' });
      mockSessionRepo.findById.mockResolvedValue(session);
      mockSessionRepo.delete.mockResolvedValue(true);

      // Act
      await service.deleteSession('sess-123');

      // Assert
      expect(mockSessionRepo.delete).toHaveBeenCalledWith('sess-123');
    });

    it('should_throwError_when_sessionNotFound', async () => {
      // Arrange
      mockSessionRepo.findById.mockResolvedValue(null);

      // Act & Assert
      await expect(
        service.deleteSession('invalid')
      ).rejects.toThrow('ERR_SESSION_NOT_FOUND');
    });
  });
});
```

---

## 8. 커버리지 및 품질 메트릭

### 8.1 커버리지 목표

| 레이어 | 목표 커버리지 | 이유 |
|--------|--------------|------|
| **Routes** | 90%+ | API 계약 보장 |
| **Services** | 95%+ | 핵심 비즈니스 로직 |
| **Repositories** | 85%+ | 데이터 접근 계층 |
| **Utils** | 95%+ | 순수 함수, 재사용 로직 |
| **전체** | 90%+ | 전반적인 품질 보장 |

### 8.2 추적할 메트릭

```typescript
// vitest.config.ts
export default defineConfig({
  test: {
    coverage: {
      lines: 90,           // 라인 커버리지
      functions: 90,       // 함수 커버리지
      branches: 85,        // 분기 커버리지
      statements: 90       // 구문 커버리지
    }
  }
});
```

### 8.3 커버리지 리포트 생성

```bash
# 커버리지 포함 테스트 실행
npm run test:coverage

# HTML 리포트 생성
npm run test:coverage -- --reporter=html

# 임계값 확인
npm run test:coverage:check
```

### 8.4 CI/CD 통합

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Check coverage thresholds
        run: npm run test:coverage:check

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json
          fail_ci_if_error: true
```

---

## 9. 일반적인 패턴 및 안티패턴

### 9.1 ✅ 해야 할 것 (Best Practices)

#### AAA 패턴 사용
```typescript
it('should_doSomething_when_condition', () => {
  // Arrange - 준비
  const input = createTestData();

  // Act - 실행
  const result = functionUnderTest(input);

  // Assert - 검증
  expect(result).toBe(expectedValue);
});
```

#### 설명적인 테스트 이름
```typescript
// ✅ Good
it('should_return404_when_sessionNotFound', () => {});

// ❌ Bad
it('test session', () => {});
```

#### 테스트 독립성 유지
```typescript
describe('MyService', () => {
  beforeEach(() => {
    // 각 테스트마다 새로운 인스턴스
    service = new MyService();
  });

  afterEach(() => {
    // 리소스 정리
    service.cleanup();
  });
});
```

### 9.2 ❌ 하지 말아야 할 것 (Anti-patterns)

#### 구현 세부사항 테스트 금지
```typescript
// ❌ Bad - 내부 구현 테스트
it('should call internal method', () => {
  expect(service.internalMethod).toHaveBeenCalled();
});

// ✅ Good - 동작 테스트
it('should return correct result', () => {
  expect(service.publicMethod()).toBe(expected);
});
```

#### 테스트 간 상태 공유 금지
```typescript
// ❌ Bad
let sharedState;

it('test 1', () => {
  sharedState = 'value';
});

it('test 2', () => {
  expect(sharedState).toBe('value'); // 실행 순서에 의존
});

// ✅ Good
it('test 1', () => {
  const localState = 'value'
;
  expect(localState).toBe('value');
});
```

---

## 10. 명명 규칙

### 10.1 테스트 파일명
```
src/services/SessionService.ts
└─> tests/unit/services/SessionService.test.ts

src/utils/progress.ts
└─> tests/unit/utils/progress.test.ts
```

### 10.2 테스트 이름 패턴

```typescript
// 패턴: should_[예상동작]_when_[조건]

it('should_returnSession_when_validId', () => {});
it('should_throw404_when_sessionNotFound', () => {});
it('should_calculateCorrectly_when_allCheckpointsCompleted', () => {});
```

### 10.3 Describe 블록

```typescript
describe('SessionService', () => {
  describe('createSession', () => {
    it('should_...', () => {});
  });

  describe('updateSession', () => {
    it('should_...', () => {});
  });
});
```

---

## 11. 요구사항 매핑

| 요구사항 ID | 테스트 커버리지 | 파일 위치 |
|------------|----------------|----------|
| FR-201 | GET /api/templates | tests/unit/routes/templates.test.ts |
| FR-202 | GET /api/templates/:id | tests/unit/routes/templates.test.ts |
| FR-203 | Session 진행률 계산 | tests/unit/services/SessionService.test.ts |
| FR-204 | PATCH /api/sessions/:id | tests/unit/routes/sessions.test.ts |
| FR-207 | Session 영속성/복구 | tests/unit/repositories/SessionRepository.test.ts |
| FR-401-405 | GET /api/validation-rules | tests/unit/routes/validation-rules.test.ts |

---

## 12. 구현 체크리스트

### 초기 설정
- [ ] Vitest 및 의존성 패키지 설치
- [ ] vitest.config.ts 설정
- [ ] 테스트 디렉토리 구조 생성
- [ ] setup.ts 파일 작성

### 테스트 데이터
- [ ] TemplateFactory 구현
- [ ] SessionFactory 구현
- [ ] StepFactory, CheckpointFactory 구현
- [ ] Fixture 파일 작성

### 테스트 작성
- [ ] API 엔드포인트 테스트 (7개 엔드포인트)
- [ ] 비즈니스 로직 테스트 (진행률, 복구 등)
- [ ] Repository 테스트 (CRUD, 쿼리)
- [ ] 유틸리티 함수 테스트
- [ ] 에러 핸들링 테스트 (5개 에러 코드)

### 품질 관리
- [ ] 90%+ 커버리지 달성
- [ ] 모든 테스트 통과
- [ ] CI/CD 파이프라인 설정
- [ ] 커버리지 리포트 자동화

---

## 13. 관련 문서

- [01. requirements.md](./01.%20requirements.md) - 기능 요구사항
- [02. backend_spec.md](./02.%20backend_spec.md) - API 명세
- [04. database.md](./04.%20database.md) - 데이터베이스 스키마
- [07. unit_test_design.md](./07.%20unit_test_design.md) - 전반적인 테스트 전략

---

## 14. 핵심 원칙

1. **테스트 우선 (TDD)**: 구현 전에 테스트 작성
2. **한 가지만**: 각 테스트는 하나의 동작만 검증
3. **독립성**: 테스트는 서로 의존하지 않음
4. **속도**: 단위 테스트는 밀리초 단위로 실행
5. **명확성**: 테스트 이름이 무엇을, 왜 테스트하는지 설명
6. **커버리지**: 90%+ 목표, 핵심 경로 우선순위
